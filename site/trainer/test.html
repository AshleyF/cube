<!DOCTYPE html>
<html lang=en>
    <head>
        <title>Test</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <link rel="stylesheet" type="text/css" href="styles.css">
        <script src="jquery.min.js"></script>
        <script src="roofpig_and_three.min.js"></script>
        <script src="cube.js"></script>
        <script src="display.js"></script>
        <script src="giiker.js"></script>
        <script>
            function tests() {
                var results = "";
                function test(name, fn) {
                    results += "<li style='color:" + (fn() ? "green" : "red") + "'>" + name + "</li>";
                }
                function testAlgs(algs, expected) {
                    for (var a in algs) {
                        var alg = algs[a];
                        test("Alg: " + alg, function() { return Cube.toString(Cube.alg(alg, Cube.solved)) == expected; })
                    }
                }
                test("Solved", function() { return Cube.toString(Cube.solved) == "UUUUUUUUULLLLLLLLLFFFFFFFFFRRRRRRRRRDDDDDDDDDBBBBBBBBB"; });
                testAlgs(["U"], "UUUUUUUUUFFFLLLLLLRRRFFFFFFBBBRRRRRRDDDDDDDDDBBBBBBLLL");
                testAlgs(["U2", "U2'"], "UUUUUUUUURRRLLLLLLBBBFFFFFFLLLRRRRRRDDDDDDDDDBBBBBBFFF");
                testAlgs(["U'"], "UUUUUUUUUBBBLLLLLLLLLFFFFFFFFFRRRRRRDDDDDDDDDBBBBBBRRR");
                testAlgs(["D"], "UUUUUUUUULLLLLLBBBFFFFFFLLLRRRRRRFFFDDDDDDDDDRRRBBBBBB");
                testAlgs(["D2", "D2'"], "UUUUUUUUULLLLLLRRRFFFFFFBBBRRRRRRLLLDDDDDDDDDFFFBBBBBB");
                testAlgs(["D'"], "UUUUUUUUULLLLLLFFFFFFFFFRRRRRRRRRBBBDDDDDDDDDLLLBBBBBB");
                testAlgs(["L"], "BUUBUUBUULLLLLLLLLUFFUFFUFFRRRRRRRRRFDDFDDFDDDBBDBBDBB");
                testAlgs(["L2", "L2'"], "DUUDUUDUULLLLLLLLLBFFBFFBFFRRRRRRRRRUDDUDDUDDFBBFBBFBB");
                testAlgs(["L'"], "FUUFUUFUULLLLLLLLLDFFDFFDFFRRRRRRRRRBDDBDDBDDUBBUBBUBB");
                testAlgs(["R"], "UUFUUFUUFLLLLLLLLLFFDFFDFFDRRRRRRRRRDDBDDBDDBBBUBBUBBU");
                testAlgs(["R2", "R2'"], "UUDUUDUUDLLLLLLLLLFFBFFBFFBRRRRRRRRRDDUDDUDDUBBFBBFBBF");
                testAlgs(["R'"], "UUBUUBUUBLLLLLLLLLFFUFFUFFURRRRRRRRRDDFDDFDDFBBDBBDBBD");
                testAlgs(["F"], "UUUUUULLLLLDLLDLLDFFFFFFFFFURRURRURRRRRDDDDDDBBBBBBBBB");
                testAlgs(["F2", "F2'"], "UUUUUUDDDLLRLLRLLRFFFFFFFFFLRRLRRLRRUUUDDDDDDBBBBBBBBB");
                testAlgs(["F'"], "UUUUUURRRLLULLULLUFFFFFFFFFDRRDRRDRRLLLDDDDDDBBBBBBBBB");
                testAlgs(["B"], "RRRUUUUUUULLULLULLFFFFFFFFFRRDRRDRRDDDDDDDLLLBBBBBBBBB");
                testAlgs(["B2", "B2'"], "DDDUUUUUURLLRLLRLLFFFFFFFFFRRLRRLRRLDDDDDDUUUBBBBBBBBB");
                testAlgs(["B'"], "LLLUUUUUUDLLDLLDLLFFFFFFFFFRRURRURRUDDDDDDRRRBBBBBBBBB");
                testAlgs(["M"], "UBUUBUUBULLLLLLLLLFUFFUFFUFRRRRRRRRRDFDDFDDFDBDBBDBBDB");
                testAlgs(["M2", "M2'"], "UDUUDUUDULLLLLLLLLFBFFBFFBFRRRRRRRRRDUDDUDDUDBFBBFBBFB");
                testAlgs(["M'"], "UFUUFUUFULLLLLLLLLFDFFDFFDFRRRRRRRRRDBDDBDDBDBUBBUBBUB");
                testAlgs(["E"], "UUUUUUUUULLLBBBLLLFFFLLLFFFRRRFFFRRRDDDDDDDDDBBBRRRBBB");
                testAlgs(["E2", "E2'"], "UUUUUUUUULLLRRRLLLFFFBBBFFFRRRLLLRRRDDDDDDDDDBBBFFFBBB");
                testAlgs(["E'"], "UUUUUUUUULLLFFFLLLFFFRRRFFFRRRBBBRRRDDDDDDDDDBBBLLLBBB");
                testAlgs(["S"], "UUULLLUUULDLLDLLDLFFFFFFFFFRURRURRURDDDRRRDDDBBBBBBBBB");
                testAlgs(["S2", "S2'"], "UUUDDDUUULRLLRLLRLFFFFFFFFFRLRRLRRLRDDDUUUDDDBBBBBBBBB");
                testAlgs(["S'"], "UUURRRUUULULLULLULFFFFFFFFFRDRRDRRDRDDDLLLDDDBBBBBBBBB");
                testAlgs(["u", "Uw"], "UUUUUUUUUFFFFFFLLLRRRRRRFFFBBBBBBRRRDDDDDDDDDBBBLLLLLL");
                testAlgs(["u2", "u2'", "Uw2", "Uw2'"], "UUUUUUUUURRRRRRLLLBBBBBBFFFLLLLLLRRRDDDDDDDDDBBBFFFFFF");
                testAlgs(["u'", "Uw'"], "UUUUUUUUUBBBBBBLLLLLLLLLFFFFFFFFFRRRDDDDDDDDDBBBRRRRRR");
                testAlgs(["d", "Dw"], "UUUUUUUUULLLBBBBBBFFFLLLLLLRRRFFFFFFDDDDDDDDDRRRRRRBBB");
                testAlgs(["d2", "d2'", "Dw2", "Dw2'"], "UUUUUUUUULLLRRRRRRFFFBBBBBBRRRLLLLLLDDDDDDDDDFFFFFFBBB");
                testAlgs(["d'", "Dw'"], "UUUUUUUUUBBBFFFFFFLLLRRRRRRFFFBBBBBBDDDDDDDDDLLLLLLRRR");
                testAlgs(["l", "Lw"], "BBUBBUBBULLLLLLLLLUUFUUFUUFRRRRRRRRRFFDFFDFFDDDBDDBDDB");
                testAlgs(["l2", "l2'", "Lw2", "Lw2'"], "DDUDDUDDULLLLLLLLLBBFBBFBBFRRRRRRRRRUUDUUDUUDFFBFFBFFB");
                testAlgs(["l'", "Lw'"], "FFUFFUFFULLLLLLLLLDDFDDFDDFRRRRRRRRRBBDBBDBBDUUBUUBUUB");
                testAlgs(["r", "Rw"], "UFFUFFUFFLLLLLLLLLFDDFDDFDDRRRRRRRRRDBBDBBDBBBUUBUUBUU");
                testAlgs(["r2", "r2'", "Rw2", "Rw2'"], "UDDUDDUDDLLLLLLLLLFBBFBBFBBRRRRRRRRRDUUDUUDUUBFFBFFBFF");
                testAlgs(["r'", "Rw'"], "UBBUBBUBBLLLLLLLLLFUUFUUFUURRRRRRRRRDFFDFFDFFBDDBDDBDD");
                testAlgs(["f", "Fw"], "UUULLLLLLLDDLDDLDDFFFFFFFFFUURUURUURRRRRRRDDDBBBBBBBBB");
                testAlgs(["f2", "f2'", "Fw2", "Fw2'"], "UUUDDDDDDLRRLRRLRRFFFFFFFFFLLRLLRLLRUUUUUUDDDBBBBBBBBB");
                testAlgs(["f'", "Fw'"], "UUURRRRRRLUULUULUUFFFFFFFFFDDRDDRDDRLLLLLLDDDBBBBBBBBB");
                testAlgs(["b", "Bw"], "RRRRRRUUUUULUULUULFFFFFFFFFRDDRDDRDDDDDLLLLLLBBBBBBBBB");
                testAlgs(["b2", "b2'", "Bw2", "Bw2'"], "DDDDDDUUURRLRRLRRLFFFFFFFFFRLLRLLRLLDDDUUUUUUBBBBBBBBB");
                testAlgs(["b'", "Bw'"], "LLLLLLUUUDDLDDLDDLFFFFFFFFFRUURUURUUDDDRRRRRRBBBBBBBBB");
                testAlgs(["U' D L2 U B2 D2 B2 D2 L F' U D' R U' F2 L F' B'"], "UUUUUUUUULBLBLDLBLFFFFFFFFFRRRRRRRRRDLDDDBDLDBDBLBDBLB"); // "magic"
                testAlgs(["M2 U' R2 D' S M2 U M' U2 F2 D' S M2 U' R2 U'"], "DLDBDFDRDBDBLBRBUBRDRBRFRURFDFRFLFUFURUBUFULULULBLFLDL"); // superflip
                test("Comparison", function() { return Cube.same(Cube.alg("U L", Cube.solved), Cube.alg("U L", Cube.solved)); });
                test("Equivalent", function() { return Cube.same(Cube.alg("U R", Cube.solved), Cube.alg("x2 D R", Cube.solved)); });
                document.getElementById("results").innerHTML = results;
            }

            function displayAlg(alg) {
                var cube = Cube.alg(alg, Cube.solved);
                document.getElementById("debug").innerText = Cube.toString(cube);
                function delay() {
                    Display.display3DCube(Cube.faces(cube), "cube");
                    Display.displayLL(Cube.faces(cube), "ll");
                    Display.displayUF(Cube.faces(cube), "uf");
                }
                window.setTimeout(delay, 1);
            }

            var instance = Cube.solved;

            function update(cube) {
                Display.displayLL(Cube.faces(cube), "ll");
                Display.displayUF(Cube.faces(cube), "uf");
                Display.display3DCube(Cube.faces(cube), "cube");
            }

            function load() {
                tests();
                // displayAlg("S'");
                function delay() { refresh(); }
                window.setTimeout(delay, 1);
            }

            var alg = "";
            var solution = "";
            var verify;

            function check() {
                var rotations = ["", "x", "x y", "x y'", "x y2", "x z", "x z'", "x z2", "x'", "x' y", "x' y'", "x' z", "x' z'", "x2", "x2 y", "x2 y'", "x2 z", "x2 z'", "y", "y'", "y2", "z", "z'", "z2"];
                for (var i = 0; i < rotations.length; i++) {
                    var rot = rotations[i];
                    // apply rotation, alg, inverse rotation
                    var result = Cube.alg(rot, Cube.alg(alg, Cube.alg(rot, instance)), true);
                    if (verify(result)) {
                        update(result);
                        document.getElementById("status").innerText = "Well done!";
                        document.body.style.backgroundColor = "green";
                        window.setTimeout(next, 3000);
                        return true;
                    }
                }
            }

            function twist(t) {
                if (t == "") return;
                alg += t + ' ';
                var result = Cube.alg(alg, instance);
                // update(result);
                var len = alg.split(' ').length;
                var progress = "";
                for (var i = 1; i < len; i++) {
                    progress += "&bull; ";
                }
                document.getElementById("status").innerHTML = progress;
                document.body.style.backgroundColor = "#333";
                check();
            }

            function connected() {
                var btn = document.getElementById("giiker");
                btn.disabled = false;
                btn.innerText = "Disconnect";
            }

            function giiker() {
                var btn = document.getElementById("giiker");
                if (Giiker.connected()) {
                    btn.disabled = false;
                    btn.innerText = "Connect";
                    Giiker.disconnect();
                } else {
                    btn.disabled = true;
                    btn.innerText = "Connecting...";
                    Giiker.connect(connected, twist, error);
                }
            }

            function disconnect() {
                var btn = document.getElementById("giiker");
                btn.disabled = false;
                btn.innerText = "Connect";
                Giiker.disconnect();
            }

            function error(ex) {
                var btn = document.getElementById("giiker");
                btn.disabled = false;
                btn.innerText = "Connect";
                alert("Error: " + ex.message);
            }

            function next() {
                refresh(); // TODO
            }

            function refresh() {
                alg = "";
                challenge(
                    "R U R' U R U2 R'",
                    function(result) {
                        var rf = Cube.faces(result);
                        var ef = Cube.faces(Cube.alg(solution, instance));
                        var rbl = Cube.faceColor("Ubl", rf);
                        var ebl = Cube.faceColor("Ubl", ef);
                        var rbr = Cube.faceColor("Ubr", rf);
                        var ebr = Cube.faceColor("Ubr", ef);
                        var rfl = Cube.faceColor("Ufl", rf);
                        var efl = Cube.faceColor("Ufl", ef);
                        var rfr = Cube.faceColor("Ufr", rf);
                        var efr = Cube.faceColor("Ufr", ef);
                        return rbl == ebl && rbr == ebr && rfl == efl && rfr == efr;
                    });
                update(instance);
                document.getElementById("status").innerText = "Good luck!";
                document.body.style.backgroundColor = "black";
            }

            function challenge(alg, expected) {
                verify = expected;
                var auf = ["", "U ", "U' ", "U2 "][Math.floor(Math.random() * 4)]
                solution = auf + alg;
                instance = Cube.solved;
                // instance = Cube.random(["x", "x'", "x2", "y", "y'", "y2", "z", "z'", "z2"], 100, instance);
                instance = Cube.alg("x", instance);
                instance = Cube.random(["U", "U'", "U2", "M", "M'", "M2"], 100, instance);
                instance = Cube.alg(solution, instance, true);
            }
        </script>
    </head>
    <body onload="load()" style="background: black">
        <h1>Tests v0.16</h1>
        <div id="status">Welcome</div>
        <button id="giiker" onclick="giiker()">Connect</button>
        <button onclick="twist(prompt('Twists'))">SimTwists</button>
        <hr />
        <button onclick="refresh()">Refresh</button>
        <div id="ll" style="width: 150px"></div>
        <div id="cube" style="width: 350px"></div>
        <div id="uf" style="width: 150px"></div>
        <p id="debug"></p>
        <ol id="results">
        </ol>
    </body>
</html>
